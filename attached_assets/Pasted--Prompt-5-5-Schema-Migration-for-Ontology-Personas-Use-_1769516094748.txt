# Prompt 5.5: Schema Migration for Ontology & Personas

> **Use Build Mode**

```
[OBJECTIVE]
Migrate the database schema and seed data to support the enhanced ISO 27001 ontology 
with persona-based questionnaires. This prepares the foundation for Prompt 6.

[CONTEXT]
We have a comprehensive ISO 27001 ontology (iso_27001_ontology.json) that provides:
- 100 controls with 503 audit questions
- 3 user personas: Auditor (282 questions), Advisor (195), Analyst (26)
- Rich question metadata: guidance, evidence types, red flags, severity, etc.

Current state after Prompt 5:
- 90 controls seeded with grouped entries (e.g., "7.1 to 7.7")
- organisation_controls table has records for all 90
- Test recording form exists and works
- No persona support yet

We need to:
1. Replace 90 controls with 100 individual controls from ontology
2. Add persona support to schema
3. Load rich questionnaire data from ontology
4. Preserve test history (test_runs table unchanged)

[SCHEMA CHANGES]

### 1. Add column to `controls` table

```sql
-- No new columns needed to controls table
-- ai_questionnaire JSONB already exists, we'll update its structure
-- questionnaire_generated_at already exists
```

### 2. Add column to `organisation_controls` table

```sql
ALTER TABLE organisation_controls 
ADD COLUMN IF NOT EXISTS selected_persona VARCHAR(20) DEFAULT 'Auditor';

-- Add constraint
ALTER TABLE organisation_controls 
ADD CONSTRAINT valid_persona CHECK (selected_persona IN ('Auditor', 'Advisor', 'Analyst'));
```

### 3. Update Drizzle Schema

In `shared/schema.ts`, add:

```typescript
// Add to organisation_controls table definition
selected_persona: varchar('selected_persona', { length: 20 }).default('Auditor'),

// Add new types
export const personaEnum = ['Auditor', 'Advisor', 'Analyst'] as const;
export type Persona = typeof personaEnum[number];
```

### 4. Enhanced TypeScript Types

Add to `shared/types.ts`:

```typescript
export type Persona = 'Auditor' | 'Advisor' | 'Analyst';
export type Severity = 'Critical' | 'High' | 'Medium' | 'Low';

export interface OntologyQuestion {
  question_id: number;
  question: string;
  guidance: string;
  auditor_focus: string;
  evidence_type: string;
  answer_type: string;
  what_good_looks_like: string;
  red_flags: string;
  nc_pattern: string;
  severity: Severity;
  primary_persona: Persona;
  related_controls: string;
}

export interface ControlQuestionnaire {
  questions: OntologyQuestion[];
  metadata: {
    total_questions: number;
    by_persona: Record<Persona, number>;
  };
}

export interface QuestionResponse {
  question_id: number;
  response_text: string;
  evidence_references: string[];
  last_updated: string;
  answered_by_user_id: number;
}

export interface ImplementationResponses {
  responses: QuestionResponse[];
  completion_status: {
    total: number;
    answered: number;
    by_persona: Record<Persona, { total: number; answered: number }>;
  };
}
```

[ONTOLOGY MIGRATION]

### Step 1: Create Ontology Loader Script

Create `scripts/load-ontology.ts`:

```typescript
// This script:
// 1. Reads iso_27001_ontology.json
// 2. Deletes existing controls (but NOT test_runs - preserve audit history)
// 3. Inserts 100 controls with full questionnaire data
// 4. Creates organisation_controls for each new control
// 5. Logs the migration as an ai_interaction

// Key logic:
// - Map ontology category names to existing category IDs
// - Transform ontology questions array to ai_questionnaire JSONB
// - Set questionnaire_generated_at to current timestamp
// - Default owner_role based on category:
//   - ISMS Requirements → 'IS'
//   - Organisational Controls → 'IS' 
//   - People Controls → 'HR'
//   - Physical Controls → 'Facilities'
//   - Technological Controls → 'SOC Team'
// - Default frequency: 'Annual' (can be overridden per control)
// - Default start_quarter: 'Q1'
```

### Step 2: Handle Test History

IMPORTANT: The `test_runs` table references `organisation_controls.id`. 
Migration must:
1. Note which control_numbers have existing test_runs
2. After creating new organisation_controls, the old test history is orphaned
3. For V1 MVP: Accept that test history resets (document this clearly)
4. Alternative: Create mapping table (complexity not worth it for V1)

Decision: **Reset test history** during migration. Log warning to user.

### Step 3: Seed Script Update

Modify `scripts/seed.ts` to:
1. Check for ONTOLOGY_LOADED flag in database or config
2. If not loaded, run ontology loader instead of original seed
3. Set flag after successful load

### Step 4: Category Mapping

Ontology uses these category names (map to existing IDs):
```
"ISMS Requirements" → category_id 1
"Organisational Controls" → category_id 2
"People Controls" → category_id 3
"Physical Controls" → category_id 4
"Technological Controls" → category_id 5
```

[IMPLEMENTATION STEPS]

1. **Run migration** to add `selected_persona` column:
   - Create `migrations/005_add_persona.ts`
   - Add column with default 'Auditor'

2. **Create ontology loader**:
   - Read JSON file
   - Transform to database format
   - Clear and reload controls
   - Create organisation_controls records

3. **Update types**:
   - Add Persona type
   - Add OntologyQuestion interface
   - Update ControlQuestionnaire type

4. **Log migration**:
   - Insert ai_interactions record with:
     - interaction_type: 'questionnaire_generation' (or add new type)
     - input_summary: 'Ontology bulk load from iso_27001_ontology.json'
     - output_summary: '100 controls, 503 questions loaded'

[DATA TRANSFORMATION]

From ontology JSON:
```json
{
  "control_number": "RQ4",
  "control_name": "Context of the Organisation and Scope",
  "category": "ISMS Requirements",
  "questions": [
    {
      "question_id": 1,
      "question": "...",
      "guidance": "...",
      ...
    }
  ]
}
```

To database:
```sql
INSERT INTO controls (
  control_number,
  name,
  description,
  category_id,
  owner_role,
  default_frequency,
  start_quarter,
  ai_questionnaire,
  questionnaire_generated_at
) VALUES (
  'RQ4',
  'Context of the Organisation and Scope',
  (first question's guidance as summary),
  1,  -- ISMS Requirements
  'IS',
  'Annual',
  'Q1',
  '{"questions": [...], "metadata": {"total_questions": 6, "by_persona": {...}}}',
  NOW()
);
```

[VERIFICATION CHECKLIST]

After running migration and ontology load:
- [ ] 100 controls in database (SELECT COUNT(*) FROM controls)
- [ ] 5 categories unchanged
- [ ] Each control has ai_questionnaire with questions array
- [ ] organisation_controls has 100 records with selected_persona = 'Auditor'
- [ ] TypeScript compiles without errors
- [ ] Existing API endpoints still work (/api/controls, /api/controls/:id)
- [ ] Controls list page loads and shows 100 controls
- [ ] Control detail page shows questionnaire tab (may be empty UI for now)

[FILES TO PROVIDE]

After checkpoint, I will provide:
- `iso_27001_ontology.json` - Place in project root or `seed-data/`

[WARNING TO USER]

Display this message after migration:
"Ontology migration complete. 100 controls loaded with 503 audit questions. 
Note: Previous test history has been reset. This is expected for the ontology upgrade."

[ACCEPTANCE CRITERIA]
- [ ] selected_persona column added to organisation_controls
- [ ] 100 controls loaded from ontology
- [ ] 503 questions distributed across controls
- [ ] Persona counts correct: Auditor=282, Advisor=195, Analyst=26
- [ ] Types updated and compiling
- [ ] Migration logged to ai_interactions
- [ ] Existing pages still functional

**Create checkpoint: "Ontology Schema Migration"**
```

---

## After Checkpoint: Load Ontology Data

Once Replit confirms checkpoint, paste:

```
Now ask me for the ontology data. I will upload file iso_27001_ontology.json.

The run the ontology loader to:
1. Clear existing controls
2. Insert 100 controls from ontology
3. Create organisation_controls for each
4. Verify counts match expected (100 controls, 503 questions)
```